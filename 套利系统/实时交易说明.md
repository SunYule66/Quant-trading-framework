# 实时套利交易系统使用说明

## 概述

本系统将回测套利逻辑转换为实时交易系统，可以在OKX和Binance两个交易所之间进行自动套利交易。

## 系统架构

```
回测系统 (logic.py)
    ↓
实时交易系统 (realtime_trading.py)
    ↓
API客户端 (api_clients_example.py)
    ↓
交易所 (OKX + Binance)
```

## 实施步骤

### 1. 安装依赖

```bash
# OKX API
pip install okx

# Binance API
pip install python-binance

# 其他依赖
pip install pandas numpy
```

### 2. 配置API密钥

1. 在OKX和Binance创建API密钥
2. 复制 `config_example.py` 为 `config.py`
3. 填入真实的API密钥
4. **重要**：先在测试环境（sandbox/testnet）测试

### 马丁策略 · 模拟盘交易设置

马丁策略（`method/martin_bidirectional.py`）实时模式下支持**模拟盘下单**：

- **config.py** 中新增 `MARTIN_PAPER_TRADE`：
  - `True`：实时模式会在交易所**测试环境**下单（OKX 沙箱 / Binance 测试网），使用 `OKX_CONFIG`、`BINANCE_CONFIG` 中的 `sandbox`/`testnet` 与对应 API Key。
  - `False`：仅跑策略信号，不向交易所下单。
- 使用配置文件启动时，可在 JSON 中设置 `"paper_trade": true/false`，覆盖 `config.MARTIN_PAPER_TRADE`。
- 运行实时模式：`python method/martin_bidirectional.py --config results/run_config.json`，且需在配置中把 `run_mode` 设为 `realtime`。

### 3. 实现API客户端

根据 `api_clients_example.py` 中的示例，实现完整的API客户端：

- `get_ticker()`: 获取最新价格
- `get_funding_rate()`: 获取资金费率
- `get_klines()`: 获取历史K线数据
- `place_order()`: 下单

### 4. 修改实时交易系统

在 `realtime_trading.py` 中：

1. **完善数据获取**：
   - 实现 `get_current_data()` 的完整逻辑
   - 实现 `get_history_data()` 的完整逻辑

2. **完善交易执行**：
   - 实现 `execute_open_position()` 的完整逻辑
   - 实现 `execute_close_position()` 的完整逻辑
   - 添加订单确认和错误处理

3. **完善条件检查**：
   - 实现 `check_open_condition()` 的完整逻辑
   - 实现 `check_close_condition()` 的完整逻辑
   - 确保与回测逻辑一致

### 5. 添加风险控制

在实时交易系统中添加：

- **资金管理**：
  - 检查账户余额
  - 限制单笔交易金额
  - 限制总仓位

- **风险限制**：
  - 最大日亏损限制
  - 最大单笔亏损限制
  - 紧急止损机制

- **订单管理**：
  - 订单状态确认
  - 订单失败重试
  - 部分成交处理

### 6. 测试

**重要：先在测试环境充分测试！**

1. 使用沙箱/测试网环境
2. 使用小额资金测试
3. 监控日志输出
4. 验证订单执行
5. 验证平仓逻辑

### 7. 部署

1. 使用服务器或云服务运行
2. 设置进程守护（如systemd、supervisor）
3. 配置日志轮转
4. 设置监控告警

## 关键注意事项

### ⚠️ 风险警告

1. **API安全**：
   - 不要在代码中硬编码API密钥
   - 使用环境变量或加密配置文件
   - 限制API权限（只允许交易，不允许提现）

2. **网络延迟**：
   - 两个交易所的订单可能不同步执行
   - 需要考虑网络延迟和订单执行时间
   - 建议使用限价单而非市价单（减少滑点）

3. **资金费率风险**：
   - 资金费率可能快速变化
   - 持仓时间过长可能导致资金费率成本超过价差收益

4. **流动性风险**：
   - 大额订单可能影响价格
   - 需要检查订单簿深度

5. **系统故障**：
   - 需要处理API故障、网络中断等情况
   - 实现自动重连和错误恢复

### 🔧 技术要点

1. **数据同步**：
   - 确保两个交易所的数据时间戳对齐
   - 处理数据延迟和缺失

2. **订单执行**：
   - 考虑使用限价单减少滑点
   - 实现订单状态轮询
   - 处理部分成交情况

3. **持仓管理**：
   - 实时跟踪持仓状态
   - 处理异常持仓（如只有一边成交）

4. **性能优化**：
   - 减少API调用频率
   - 使用WebSocket实时数据（可选）

## 运行示例

```python
from logic import ArbitrageSystem
from realtime_trading import RealtimeArbitrageTrader
from api_clients_example import OKXAPI, BinanceAPI
import config

# 初始化套利系统
system = ArbitrageSystem(**config.ARBITRAGE_CONFIG)

# 初始化API客户端
okx_api = OKXAPI(**config.OKX_CONFIG)
binance_api = BinanceAPI(**config.BINANCE_CONFIG)

# 创建实时交易器
trader = RealtimeArbitrageTrader(system, okx_api, binance_api)

# 运行交易系统
try:
    trader.run(interval=60)  # 每60秒检查一次
except KeyboardInterrupt:
    trader.stop()
```

## 监控和日志

系统会记录：
- 所有交易操作
- 订单执行结果
- 错误和异常
- 收益统计

日志文件：`套利系统/trading.log`

## 后续优化

1. **使用WebSocket**：实时获取价格和资金费率，减少延迟
2. **多币种支持**：扩展到其他交易对
3. **策略优化**：根据实时表现调整参数
4. **风险模型**：添加更复杂的风险控制
5. **回测对比**：实时交易结果与回测结果对比分析

## 免责声明

⚠️ **本系统仅供学习和研究使用。实盘交易存在风险，可能导致资金损失。使用前请充分测试，并自行承担所有风险。**

